{% extends 'base.html' %} # use the base template as a parent
{% block mainBody %}
	<!-- Verify that we have a calendar -->
	{% if user %}
	<h1>Welcome, {{user}}!</h1>
	<p>
		Month details:<br>
		{{weeks}}<br>
		{% for week in weeks %}
			{{week}}<br>
		{% endfor %}
		First day of month: {{weekday}}
		<div id="week0"></div>
		<div id="week1"></div>
		<div id="week2"></div>
		<div id="week3"></div>
		<div id="week4"></div>
		<div id="week5"></div>
	</p>
	{% else %}
	<p>It appears that you aren't logged in.  Follow the link below to remedy that.</p>
	<a href={{url_for('login')}}>Login Page</a>
	{% endif %}
	<p id='comsField'></p>
	<br><br>
	<div class="container" id="viewChange">
		<button class='btn' type="button" id="day">Day View</button>
		<button class='btn' type="button" id="week">Week View</button>
		<button class='btn' type="button" id="year">Year View</button>
	</div>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
<script>

function generate_week_btns(week){
			[1,2] length 2 offset 5
	names = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
	var prefix = "<button class='btn' type='button' id=day"
	var suffix = "</button>"
	result = Array();
	if (week.length() < 7){
		// Case beginning of month week
		var offset = 7 - week.length();
		if(week[0] < 15){
			for(var i = 0; i<week.length(); i++){
				result.push( prefix + week[i] + ">" + names[i+offset] + suffix);
			}
		}
		// Case end of month week
		else{
			for(var i = 0; i<week.length(); i++){
				result.push( prefix + week[i] + ">" + names[7-week.length() + i] + suffix);
			}
		}
	}
	else{
		for(var i = 0; i<week.length(); i++){
			result.push( prefix + week[i] + ">" + names[i] + suffix );
		}
	}
	return result;
};

var allWeeks = {{weeks}};
var month = {{month}};
for(var i = 0; i <allWeeks.length; i++;){
	// Locate a week element
	var name = '#week' + i;

	// Generate a set of buttons
	this_week = generate_week_btns(allWeeks[i]);

	// Append the buttons
	$(name).append(this_week);
}

// Button handler for views
$(function(){
	$('#viewChange').find('*').click(function(){
		var payload = 'view=' + $(this).attr("id");
		$.ajax({
			url: 	 '/viewChange',
			data:    payload,
			type: 	 'POST',
			success: function(reply){
				// Once the server has confirmed a change, redirect
				// Parse the JSON into an object
				payload = JSON.parse(reply);
				if (payload.status == 'OK'){
					console.log("Changed view successfully");
					// redirect, cueing the server to display the updated view
					window.location.replace(payload.link);
					//window.location.replace("http://localhost:5000/");
				}
				else{
					console.log('Bad status: ');
					console.log(payload);
				}
			}
		});// End ajax
	});
});

function failMessage(msg){
	$('#comsField').css('color', 'red');
	$('#comsField').text(msg);
}


// This function was taken from a stackexchange post, which is kind of
// ridiculous considering JavaScript is a web language.  It should be built in..
// Retrieved September 2016
// http://stackoverflow.com/questions/16171320/remove-all-slashes-in-javascript#16171353
function sanitize(word){
	console.log(word);
	result = word.replace(/\\/g, '');
	result = result.replace(/\/\//g, '');
	result = result.replace(/\&/g, '');
	result = result.replace(/%/g, '');
	result = result.replace(/\$/g, '');
	result = result.replace(/#/g, '');
	console.log(result);
	return result;
}

function serialize(names,vals){
	equals = '=';
	delimiter = '&';
	result = Array();
	for(var i = 0; i < vals.length; i++){
		result.push(names[i] + equals + vals[i])
	}
	return result.join(delimiter)
}

function successMessage(msg){
	$('#comsField').css('color', 'green');
	$('#comsField').text(msg);
}

</script>
{% endblock %}
